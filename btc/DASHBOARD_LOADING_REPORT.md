# BTC 대시보드 "로딩만 뜨는 문제" 보고서

## 1. 관련 파일

| 파일 | 역할 |
|------|------|
| `btc/btc_dashboard.py` | 단일 파일: FastAPI 앱 + HTML/JS/CSS 인라인, 포트 8080 |
| `scripts/run_dashboard.sh` | env 로드 후 uvicorn 실행 (참고용, 현재는 `python3 btc/btc_dashboard.py`로 직접 실행 중) |

---

## 2. 대시보드 동작 흐름

```
[브라우저] GET http://서버:8080/
    → 서버가 HTML 한 번 내려줌 (가격/스탯은 아직 "--", 테이블은 "불러오는 중...")

[브라우저] HTML 안의 <script> 실행
    → loadAll() 호출
    → fetch('/api/stats'), fetch('/api/trades'), fetch('/api/logs'), fetch('/api/system'), fetch('/api/brain'), fetch('.../fng/') 병렬 호출

[중요] fetch('/api/stats') 등은 **현재 페이지가 열린 주소** 기준 상대 경로
    → 예: 페이지가 http://서버IP:8080/ 로 열렸으면 → http://서버IP:8080/api/stats 로 요청 (같은 출처)
    → 예: 페이지가 https://다른도메인/ 로 열렸으면 → https://다른도메인/api/stats 로 요청 → 404 또는 CORS 실패

[서버] /api/stats, /api/trades 등은 127.0.0.1:8080 에서 정상 200 응답 확인됨.
```

즉, **서버 쪽 API는 정상**이고, **브라우저가 어떤 주소로 페이지를 열었는지**에 따라 API 요청이 갈 주소가 결정됩니다.

---

## 3. "로딩만 뜨고 아무것도 안 뜨는" 원인

- **가격/스탯/거래**는 전부 **fetch('/api/stats'), fetch('/api/trades')** 결과로 채워짐.
- 이 fetch가 **실패**하면 (응답 없음, 404, CORS 등):
  - `loadStats()` catch → 가격만 `'--'` 로 두고 끝.
  - `loadTrades()` catch → 테이블을 "거래 로드 실패"로 바꿔야 하는데, **요청 자체가 다른 호스트로 가면** 응답을 못 받아서 실패.
- **페이지를 "대시보드 서버(8080)가 아닌 다른 주소"로 열었을 가능성이 큼.**

가능한 경우:

1. **Cursor 포워딩/프리뷰**
   - 예: Cursor가 `http://localhost:어떤포트` 로 8080을 포워딩해 주는데, 브라우저 주소창은 `http://localhost:어떤포트` 로 보임.
   - 이 경우 같은 머신이면 `localhost:어떤포트/api/stats` 로 가서, 포워딩이 제대로 되면 동작할 수 있음.
   - 반대로, **HTML만 다른 서버에서 오고** API는 8080으로 안 가게 설정돼 있으면 → API 실패 → 로딩만 보임.

2. **다른 도메인/포트에서 페이지 오픈**
   - 예: `https://xxx.com` 에서 이 대시보드 HTML을 서빙하고, 스크립트는 그대로 `fetch('/api/stats')` 라고 하면 → `https://xxx.com/api/stats` 로만 요청함 → 8080 서버와 무관 → 실패.

3. **캐시**
   - 예전에 "로딩 중..." 이 있던 HTML이 캐시돼 있으면, 지금 수정한 "--" / "불러오는 중..." 이 안 보일 수 있음.

---

## 4. 코드 상 "로딩"이 나오는 위치

- **초기 HTML**
  - 가격: `id="hero-price"` → 현재 코드 기준 **`--`** (이미 "로딩 중..." → "--" 로 수정됨).
  - 테이블: `id="trade-loading"` → **"불러오는 중..."** (스피너 + 이 문구).
- **5초 후**
  - 테이블이 그대로 "불러오는 중..."이면 → **"연결 실패. 이 페이지를 서버 주소(예: http://서버:8080)로 열었는지 확인 후 새로고침(Ctrl+Shift+R) 해 주세요."** 로 바꿔 줌.
- **에러 시**
  - log-viewer, system-box, brain-box: **"로딩 실패"** 문구.

그래서 "로딩만 뜬다"면:
- 처음엔 **"--"** + **"불러오는 중..."** 이 보이고,
- API가 계속 실패하면 5초 뒤 **"연결 실패. 이 페이지를 서버 주소(예: http://서버:8080)로..."** 로 바뀌는 구조가 맞음.
- **5초 메시지까지 안 보이고 계속 "로딩만" 보인다**면, 예전 HTML이 캐시됐거나 **다른 페이지(다른 HTML)** 를 보고 있을 수 있음.

---

## 5. 해결 방법 (체크리스트)

1. **반드시 대시보드 서버 주소로만 접속**
   - 브라우저 주소창에 **`http://서버IP:8080`** 또는 **`http://localhost:8080`** (서버 본인일 때) 만 사용.
   - 다른 도메인/포트에서 "대시보드처럼 보이는 페이지"를 열지 말 것.

2. **강력 새로고침**
   - **Ctrl+Shift+R** (Mac: Cmd+Shift+R) 로 캐시 없이 새로고침.

3. **5초 기다리기**
   - 5초 후에도 테이블이 "불러오는 중..."이면 → "연결 실패. 이 페이지를 서버 주소(예: http://서버:8080)로..." 로 바뀌는지 확인.
   - 이 메시지가 뜨면 → **같은 주소로 접속했는지, 8080이 맞는지** 다시 확인.

4. **브라우저 개발자 도구**
   - F12 → **Network** 탭에서 `stats`, `trades` 요청이 가는 **URL**과 **상태 코드** 확인.
   - **Console** 탭에 `stats error`, `trades error` 등이 찍혀 있으면, 그 에러 메시지로 원인 파악 가능.

5. **서버/프로세스 확인**
   - 대시보드는 다음으로 동작 중이어야 함:
     - `ps aux | grep btc_dashboard` → `python3 btc/btc_dashboard.py` 프로세스
     - `sudo ss -tlnp | grep 8080` → 0.0.0.0:8080 LISTEN

---

## 6. 요약

- **원인**: 대시보드 HTML은 받았지만, **API 요청이 8080 서버로 가지 않음** (다른 출처에서 페이지 오픈 or 캐시).
- **해결**: **항상 `http://서버:8080` 으로만 접속** + **Ctrl+Shift+R** 새로고침.
- **확인**: 5초 후 "연결 실패. 이 페이지를 서버 주소(예: http://서버:8080)로..." 문구가 나오면, 접속 주소를 그대로 **http://서버:8080** 으로 맞추면 됨.
